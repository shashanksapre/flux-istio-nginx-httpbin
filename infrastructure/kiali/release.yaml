apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kiali
  namespace: istio-system
spec:
  releaseName: kiali
  chart:
    spec:
      chart: ./kiali-server
      sourceRef:
        kind: GitRepository
        name: kiali
        namespace: flux-system
  dependsOn:
  - name: istio-discovery
  - name: ingress-nginx
    namespace: default
  # - name: jaeger
  # - name: grafana
  - name: prometheus
  interval: 5m
  values:
    auth:
      strategy: "anonymous"
    deployment:
      image_version: v1.36.2
      version_label: v1.36.2
      pod_annotations:
        sidecar.istio.io/inject: "false"
      custom_dashboards:
        excludes:
        - ""
        includes:
        - '*'
      ingress_enabled: true
      logger:
        log_level: "debug"
      override_ingress_yaml:
        metadata:
          annotations:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/service-upstream: "true"
            nginx.ingress.kubernetes.io/upstream-vhost: kiali.istio-system.svc.cluster.local
          # hosts:
          # - host: kiali.local
          #   paths: [ / ]
      secret_name: kiali
    istio_namespace: istio-system
    kubernetes_config:
      excluded_workloads:
      - "CronJob"
      - "DeploymentConfig"
      # - "Job"
      - "ReplicationController"
    server:
      port: 20001
      metrics_enabled: true
      metrics_port: 9090
      web_root: /kiali
      web_fqdn: kiali.local
    external_services:
      tracing:
        auth:
          ca_file: ''
          insecure_skip_verify: true
          password: ''
          token: ''
          type: none
          use_kiali_token: false
          username: ''
        enabled: true
        in_cluster_url: "http://jaeger-query.istio-system"
        namespace_selector: true
        url: 'http://jaeger.local'
        whitelist_istio_system:
        - jaeger-query
        - istio-ingressgateway
      grafana:
        auth:
          ca_file: ''
          component_status:
            app_label: grafana
            is_core: false
          insecure_skip_verify: false
          password: ''
          token: ''
          type: none
          use_kiali_token: false
          username: ''
        dashboards:
        - name: Istio Service Dashboard
          variables:
            namespace: var-namespace
            service: var-service
        - name: Istio Workload Dashboard
          variables:
            namespace: var-namespace
            workload: var-workload
        enabled: true
        in_cluster_url: http://grafana.istio-system
        url: "http://grafana.local"
      prometheus:
        auth:
          ca_file: ""
          insecure_skip_verify: false
          password: ""
          token: ""
          type: "none"
          use_kiali_token: false
          username: ""
        cache_duration: 10
        cache_enabled: true
        cache_expiration: 300
        health_check_url: ""
        is_core: true
        url: http://prometheus-server.istio-system:9090
      custom_dashboards:
        enabled: true
        prometheus:
          auth:
            ca_file: ""
            insecure_skip_verify: false
            password: ""
            token: ""
            type: "none"
            use_kiali_token: false
            username: ""
          health_check_url: ""
          url: "http://prometheus-server.istio-system:9090"